name: æ„å»ºä¸å‘å¸ƒ (æŒ‡å®šäº§ç‰©æ ¼å¼)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build_and_release:
    name: æ„å»º ${{ matrix.platform }}

    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: android
            os: ubuntu-latest
          - platform: ios
            os: macos-latest
          - platform: windows
            os: windows-latest
          - platform: macos
            os: macos-latest

    steps:
      - name: ğŸšš æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ è·å–ç‰ˆæœ¬å· (Tag åç§°)
        id: get_version
        run: echo "RELEASE_VERSION=${{ github.ref_name }}" >> $GITHUB_ENV
        shell: bash

      - name: ğŸ¦ è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: stable

          flutter-version: "3.29.0"

      - name: â˜• [Android] è®¾ç½® Java ç¯å¢ƒ
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"

          java-version: "17"
          cache: "gradle"

      - name: ğŸ’» [Windows] å¯ç”¨æ¡Œé¢æ”¯æŒ
        if: matrix.platform == 'windows'
        run: flutter config --enable-windows-desktop
      - name: ğŸ [macOS] å¯ç”¨æ¡Œé¢æ”¯æŒ
        if: matrix.platform == 'macos'
        run: flutter config --enable-macos-desktop

      - name: ğŸ“¦ è·å–ä¾èµ–
        run: flutter pub get

      - name: ğŸ¤– [Android] æ„å»º APKs
        if: matrix.platform == 'android'
        run: flutter build apk --release --split-per-abi

      - name: ğŸ [iOS] æ„å»º App (æœªç­¾å)
        if: matrix.platform == 'ios'
        run: flutter build ios --release --no-codesign

      - name: ğŸªŸ [Windows] æ„å»ºåº”ç”¨
        if: matrix.platform == 'windows'
        run: flutter build windows --release

      - name: ğŸ [macOS] æ„å»º App
        if: matrix.platform == 'macos'
        run: flutter build macos --release

      - name: ğŸ“ [Android] é‡å‘½å APKs
        if: matrix.platform == 'android'

        run: |
          cd build/app/outputs/flutter-apk/
          mv app-armeabi-v7a-release.apk BiliHardcore-AI-android-${{ env.RELEASE_VERSION }}-armeabi-v7a.apk
          mv app-arm64-v8a-release.apk BiliHardcore-AI-android-${{ env.RELEASE_VERSION }}-arm64-v8a.apk
          mv app-x86_64-release.apk BiliHardcore-AI-android-${{ env.RELEASE_VERSION }}-x86_64.apk
          mv app-release.apk BiliHardcore-AI-android-${{ env.RELEASE_VERSION }}-universal.apk

          mkdir -p ../../../../release-artifacts/android
          mv BiliHardcore-AI-android-*.apk ../../../../release-artifacts/android/
        shell: bash

      - name: ğŸ [iOS] æ‰“åŒ… IPA å’Œ ZIP (æœªç­¾å)
        if: matrix.platform == 'ios'

        run: |
          cd build/ios/Release-iphoneos

          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ../../../release-artifacts/ios/BiliHardcore-AI-ios-${{ env.RELEASE_VERSION }}-unsigned.ipa Payload
          rm -rf Payload

          zip -r ../../../release-artifacts/ios/BiliHardcore-AI-ios-${{ env.RELEASE_VERSION }}-unsigned.zip Runner.app

          mkdir -p ../../../release-artifacts/ios
        shell: bash

      - name: ğŸ [macOS] æ‰“åŒ… DMG å’Œ ZIP
        if: matrix.platform == 'macos'

        run: |
          cd build/macos/Build/Products/Release
          APP_NAME="BiliHardcore-AI.app"
          STAGING_DIR="BiliHardcore-AI Staging"
          FINAL_DMG_NAME="BiliHardcore-AI-macos-${{ env.RELEASE_VERSION }}.dmg"
          FINAL_ZIP_NAME="BiliHardcore-AI-macos-${{ env.RELEASE_VERSION }}.zip"
          OUTPUT_DIR="../../../../release-artifacts/macos"


          mkdir -p "$STAGING_DIR"

          cp -r "$APP_NAME" "$STAGING_DIR/"

          ln -s /Applications "$STAGING_DIR/Applications"


          hdiutil create -volname "BiliHardcore-AI" -srcfolder "$STAGING_DIR" -ov -format UDZO "$FINAL_DMG_NAME"


          ditto -c -k --keepParent "$APP_NAME" "$FINAL_ZIP_NAME"


          mkdir -p "$OUTPUT_DIR"
          mv "$FINAL_DMG_NAME" "$OUTPUT_DIR/"
          mv "$FINAL_ZIP_NAME" "$OUTPUT_DIR/"


          rm -rf "$STAGING_DIR"
        shell: bash

      - name: ğŸ [Windows] æ‰“åŒ… ZIP
        if: matrix.platform == 'windows'

        run: |
          cd build/windows/runner/Release
          zip -r ../../../../release-artifacts/windows/BiliHardcore-AI-windows-${{ env.RELEASE_VERSION }}.zip .

          mkdir -p ../../../../release-artifacts/windows
        shell: bash

      - name: âœ¨ åˆ›å»º GitHub Release å¹¶ä¸Šä¼ äº§ç‰©
        uses: softprops/action-gh-release@v2

        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') }}

          files: |
            release-artifacts/android/*.apk
            release-artifacts/ios/*.ipa
            release-artifacts/ios/*.zip
            release-artifacts/macos/*.dmg
            release-artifacts/macos/*.zip
            release-artifacts/windows/*.zip
